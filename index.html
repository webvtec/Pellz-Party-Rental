<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PELLZ PARTY RENTAL</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Zilla+Slab:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    body {
      font-family: 'Zilla Slab', serif;
      margin: 0;
      padding: 0;
      background-color: #FFFF;
    }

    .header-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 48px;
      background-color: #343a40;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .header-title {
      font-family: 'Zilla Slab', serif;
      font-size: 24px;
      font-weight: bold;
      background: linear-gradient(90deg, #6A0DAD, #007BFF, #2E8B57, #6A0DAD);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
      white-space: nowrap;
      text-align: center;
    }

    .menu-button {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      background-color: #6A0DAD;
      color: #FFF8DC;
      border: none;
      border-radius: 0px;
      cursor: pointer;
      height: 48px;
      width: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      padding: 0;
    }

    .menu {
      position: fixed;
      top: 48px;
      left: 0;
      width: 150px;
      background-color: rgba(0, 0, 0, 0.8);
      color: #E6B422;
      padding: 20px;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      height: auto;
      min-height: 100px;
      z-index: 999;
    }

    .menu.show {
      transform: translateX(0);
    }

    .menu a {
      display: block;
      color: white;
      margin-bottom: 15px;
      text-decoration: none;
      font-weight: bold;
      cursor: pointer;
    }

    h1 {
      text-align: center;
      color: #6c757d;
      margin-top: 80px;
    }

    form {
      max-width: 400px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
    }

    form input,
    form select,
    form button {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    form button {
      background-color: #6200ea;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    form button:hover {
      background-color: #3700b3;
    }

    #bookingMessage {
      text-align: center;
      font-weight: bold;
      color: green;
      margin-top: 20px;
    }

    .gallery-category {
      margin-top: 40px;
    }

    .gallery-category h3 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 22px;
      color: #6200ea;
      text-transform: uppercase;
    }

    .gallery-wrapper {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 10px;
    }

    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }

    @media (min-width: 768px) { /* Adjust the width as per your design */
  .gallery-grid {
    grid-template-columns: repeat(3, 1fr);  /* 3 columns on desktop */
  }
    }

@media (max-width: 600px) {
  #card-element {
    width: 100%;
    max-width: 90%;
  }
  
  .payment-button {
    width: 100%;
    max-width: 90%;
  }
}

    .gallery-grid img {
      width: 100%;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
      width: 100%;
      height: 230px;
      object-fit: cover;
    }

    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
    }

    .menu a.admin-button {
      background-color: #6A0DAD;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-family: 'Poppins', sans-serif;
      font-weight: bold;
      display: block;
      margin: 50px auto 0;
      cursor: pointer;
      transition: background-color 0.3s ease;
      text-align: center;
      width: fit-content;
    }

    .menu a.admin-button:hover {
      background-color: #3700b3;
    }

    .add-to-cart-button {
      position: absolute;
      right: 0px;
      top: 50%;
      transform: translateY(-50%);
      background-color: #6A0DAD;
      color: red;
      border: none;
      padding: 0;
      border-radius: 0px;
      cursor: pointer;
      height: 48px;
      width: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      text-decoration: none;
    }

    .separator-line {
      border-bottom: 2px solid purple;
      margin: 20px 0;
    }

    .product-card {
      background: #8c9b9f;
      border: 1px solid #eee;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 10px;
      text-align: center;
    }

    .product-card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .product-info {
      margin-top: 5px;
    }

    .product-name {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .product-price {
      color: #6200ea;
      margin-bottom: 6px;
    }

    .product-card button {
      background-color: #6A0DAD;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    
/* Cart Modal Styling */
    #cartModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 2000;
    }

    #cartModal > div {
      background: #8c9b9f;
      max-width: 320px;
      margin: 80px auto;
      border-radius: 12px;
      padding: 15px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      font-family: 'Zilla Slab', serif;
      max-height: 70vh;
      overflow-y: auto;
    }

    input,
textarea {
  width: 100%;            /* Ensure input takes full width of the container */
  padding: 10px;          /* Add padding for better user experience */
  margin: 5px 0;          /* Space between input fields */
  border-radius: 5px;     /* Rounded corners */
  border: 1px solid #ccc; /* Light border */
  box-sizing: border-box; /* Ensure padding and border are included in width */
  font-size: 16px;        /* Font size for better readability */
}

    #cartModal h2 {
      margin-top: 0;
      text-align: center;
      color: #6A0DAD;
    }

    #cartItemsContainer > div {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    #cartItemsContainer img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
      margin-right: 10px;
    }

    #cartItemsContainer span {
      font-weight: normal;
    }

    #cartItemsContainer div > div {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-grow: 1;
    }

    #cartButtons {
      display: flex;
      justify-content: center;
      margin-top: 15px;
      align-items: center;
    }

    #cartButtons button {
      flex: 1;
      align-items: center;
      padding: 10px 0;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Zilla Slab', serif;
      font-size: 16px;
      margin: 0 5px;
      transition: background-color 0.3s ease;
    }

    #checkoutBtn {
      background-color: #6200ea;
      color: white;
    }

    #checkoutBtn:hover {
      background-color: #3700b3;
    }

    #closeCartBtn {
      background-color: #ccc;
      color: black;
    }

    #closeCartBtn:hover {
      background-color: #999;
    }


    input.error {
  border: 2px solid red;
  background-color: #fff4f4;
}

/* Close Button Styling */
.close-btn {
  padding: 8px 16px;
  font-size: 14px;
  cursor: pointer;
  border: none;
  background-color: #bbb;
  color: white;
  border-radius: 8px;
  margin-top: 20px;
  margin: 10px auto;
  width: fit-content; /* only as wide as the text */
}

.close-btn:hover {
  background-color: #999;
}


/* Pay Now Button Styling */
.payment-button {
  padding: 12px 20px;
  align-items: center;
  font-size: 16px;
  cursor: pointer;
  border: none;
  text-align: center;
  background-color: #6200ea;
  color: #fff;
  border-radius: 8px;
  transition: background-color 0.3s ease, transform 0.2s ease;
  width: 100%;
  max-width: 250px;
  margin-top: 20px;
  margin: 10px auto;
}

/* Responsiveness for smaller screens */
@media (max-width: 600px) {
  .payment-modal {
    padding: 20px;
  }

  .payment-button {
    padding: 10px 15px;
    font-size: 14px;
  }
}
    
  /* Toast Notification Styling */
  #toast {
    display: none;
    position: fixed;
    bottom: 30px;
    right: 30px;
    background-color: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    z-index: 9999;
    font-weight: bold;
    transition: opacity 0.3s ease;
  }

  .swal2-popup.swal2-rounded {
  border-radius: 20px;
  padding: 30px;
  text-align: center; /* centers everything inside */
}

.swal2-title-custom {
  font-size: 28px;
  font-family: 'Poppins', sans-serif;
  font-weight: 700;
  color: #2e7d32;
  text-align: center;
}

.swal2-confirm-custom {
  background-color: #1a73e8 !important;
  color: white !important;
  font-size: 16px;
  border-radius: 8px !important;
  padding: 10px 20px;
}
  </style>
</head>

<body>

  <div class="header-bar">
  <button class="menu-button" onclick="toggleMenu()">☰</button>
  <div class="header-title">PELLZ PARTY RENTAL</div>

  <div class="add-to-cart-button" onclick="viewCart()" style="display: flex; flex-direction: column; align-items: center; background: #6A0DAD; border: none; cursor: pointer;">
    <span style="font-size: 20px;">🛒</span>
    <span id="cart-count" style="font-size: 15px; color: red; margin-top: 2px;">0</span>
  </div>
</div>

  <!-- Gallery Section -->
  <div id="gallerySection" class="content-section active">
    <h2 style="text-align:center; margin-top:60px;"></h2>
    <div id="galleryDisplay"></div>
  </div>

  <!-- Menu -->
  <div class="menu" id="menu">
    <a onclick="loadGalleryByCategory('EVENT ITEMS'); closeMenu();" href="javascript:void(0);">🎉 EVENT ITEMS</a>
    <a onclick="loadGalleryByCategory('THRILL RIDES'); closeMenu();" href="javascript:void(0);">🏁 THRILL RIDES</a>
    <a onclick="loadGalleryByCategory('CARS'); closeMenu();" href="javascript:void(0);">🚘 MOTORCARS</a>
    <a onclick="loadGalleryByCategory('BATHROOM'); closeMenu();" href="javascript:void(0);">🚻 BATHROOM</a>
    <a onclick="showSection('reviewsSection'); closeMenu();" href="javascript:void(0);">⭐️ REVIEWS</a>
    <a onclick="logoutUser(); closeMenu();" style="display:block; text-align:center; margin:10px auto; padding:10px 20px; background-color:red; color:white; border-radius:6px; cursor:pointer; text-decoration:none; width:80%; font-weight:bold;" href="javascript:void(0);">LOGOUT</a>
    <a onclick="login(); closeMenu();" class="admin-button" style="display:block; text-align:center; margin:10px auto; padding:10px 20px; background-color:#6200ea; color:white; border-radius:6px; text-decoration:none; width:80%; font-weight:bold;" href="javascript:void(0);">ADMIN</a>
  </div>

  <!-- Reviews Section -->
  <div id="reviewsSection" class="content-section" style="padding-top: 34px; background-color: black; color: white;">

  <div id="reviewFormContainer" style="
    max-width: 500px;
    margin: 10px auto 20px auto;
    background-color: #6A0DAD;
    padding: 5px;
    border-radius: 10px;
    color: black;">
    
    <form id="reviewForm" style="text-align: center;">
      <input type="text" id="reviewName" placeholder="Your Name" required
        style="width: 100%; padding: 8px; margin-bottom: 6px; border-radius: 6px; border: 1px solid #555; background-color: #fff; color: black; box-sizing: border-box;" />

      <textarea id="reviewComment" placeholder="Write your review..." required
        style="width: 100%; height: 60px; padding: 8px; margin-bottom: 6px; border-radius: 6px; border: 1px solid #555; background-color: #fff; color: black; box-sizing: border-box;"></textarea>

      <div id="starRating" style="font-size: 22px; margin-bottom: 6px; cursor: pointer; color: #ccc; letter-spacing: -2px;">
        <span data-value="1">★</span><span data-value="2">★</span><span data-value="3">★</span><span data-value="4">★</span><span data-value="5">★</span>
      </div>

      <button type="submit" style="background-color: #6200ea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
        Submit Review
      </button>
    </form>
  </div>

  <h1 style="text-align: center; color: #9b59b6; margin-top: 5px; margin-bottom: 10px;">REVIEWS</h1>

  <p id="reviewSubmitMsg" style="text-align: center; color: #7fff7f; margin-top: 0;"></p>

  <div id="reviewsContainer" style="max-width: 600px; margin: 0 auto; color: white;"></div>
</div>

<!-- Cart Modal -->
<div id="cartModal" style="display: none;"> <!-- Initially hidden -->
  <div style="position: relative;"> <!-- Wrapper to position the ✖ correctly -->

    <button id="closeCheckoutBtn" style="position: absolute; top: 10px; right: 15px; font-size: 20px; background: none; border: none; color: #6A0DAD; cursor: pointer;">
      ✖
    </button>

    <div>
      <h2>YOUR CART</h2>

      <div style="margin-bottom: 10px;">
        <label for="customerName"><strong>Your Name:</strong></label>
        <input type="text" id="customerName" placeholder="Enter your name" style="width: 100%; padding: 10px;" required />
      </div>

      <div style="margin-bottom: 15px;">
        <label for="customerPhone"><strong>Phone Number:</strong></label>
        <input type="tel" id="customerPhone" placeholder="Enter phone number" style="width: 100%; padding: 10px;" required />
      </div>

      <div style="margin-bottom: 15px;">
        <label for="rentalDateRange"><strong>Select Rental Dates:</strong></label>
        <input id="rentalDateRange" placeholder="Select start and end date" style="width: 100%; padding: 10px;" />
      </div>

      <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <div style="flex: 1;">
          <label for="startTime">Start Time:</label>
          <input type="time" id="startTime" style="width: 100%; padding: 10px;" />
        </div>
        <div style="flex: 1;">
          <label for="endTime">End Time:</label>
          <input type="time" id="endTime" style="width: 100%; padding: 10px;" />
        </div>
      </div>

      <div style="margin-bottom: 15px;">
        <label for="customerLocation"><strong>Location:</strong></label>
        <input type="text" id="customerLocation" placeholder="Enter delivery location" style="width: 100%; padding: 10px;" required />
      </div>

      <div id="cartItemsContainer"></div>
      <div id="cartTotal" style="text-align:right; font-weight:bold; margin-top: 10px;"></div>

      <div id="cartButtons" style="text-align:center; margin-top:15px;">
  <button id="payNowBtn" class="payment-button">PAY UPON ARRIVAL</button>
</div>

    </div>
  </div>
</div>
  
</style>
  
<!-- Toast Notification for Cart Addition -->
<div id="toast" style="
  display: none;
  position: fixed;
  bottom: 30px;
  right: 30px;
  background-color: #28a745;
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  z-index: 9999;
  font-weight: bold;
  transition: opacity 0.3s ease;
">Added to cart</div>

<script>
      let currentUser = null;

    const firebaseConfig = {
  apiKey: "AIzaSyDccI-TdbCXAJr6CD77X4yOUOfezef7Oks",
  authDomain: "delivery-login-3a084.firebaseapp.com",
  projectId: "delivery-login-3a084",
  storageBucket: "delivery-login-3a084.firebasestorage.app",
  messagingSenderId: "201998621677",
  appId: "1:201998621677:web:b51c3aeb2debe18b4aa5e4"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'login.html';
      } else {
        currentUser = user;
        loadReviews(currentUser);
      }
    });

  let bookedDates = [];


function fetchBookedDatesAndInitCalendar() {
  db.collection("reservations").get().then(snapshot => {
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.rentalDates) {
        const range = data.rentalDates.split(" to ");
        if (range.length === 2) {
          const start = new Date(range[0]);
          const end = new Date(range[1]);
          let current = new Date(start);
          while (current <= end) {
            bookedDates.push(current.toISOString().split('T')[0]); // Format to Y-m-d
            current.setDate(current.getDate() + 1);
          }
        }
      }
    });
  }).then(() => {
    initializeDatepicker(); // Now initialize calendar
  });
}
  
  function getRentalDayCount() {
    const rentalRange = document.getElementById('rentalDateRange').value;
    if (!rentalRange) return 1;
    const dates = rentalRange.split(' to ');
    if (dates.length !== 2) return 1;
    const start = new Date(dates[0]);
    const end = new Date(dates[1]);
    // count both start and end date, so add 1
    return Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
  }

  function getCartTotal() {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let total = 0;
    cart.forEach(item => {
      total += item.price * (item.quantity || 1);
    });
    const days = getRentalDayCount();
    return Math.round(total * days * 100); // Stripe expects cents
  }


async function completeBooking() {
  const name = document.getElementById("customerName")?.value || "N/A";
  const phone = document.getElementById("customerPhone")?.value || "N/A";
  const location = document.getElementById("customerLocation")?.value || "N/A";
  const rentalDates = document.getElementById("rentalDateRange")?.value || "N/A";
  const startTime = document.getElementById("startTime")?.value || "N/A";
  const endTime = document.getElementById("endTime")?.value || "N/A";
  const paymentType = window._stripePaymentType === "full" ? "Full Price" : "Deposit";

  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  const totalAmount = (window._stripePaymentAmount / 100).toFixed(2);

  const [startDateStr, endDateStr] = rentalDates.split(" to ");
  const start = new Date(startDateStr);
  const end = new Date(endDateStr);

  // 🔍 Load all bookings from Firestore
  const snapshot = await db.collection("reservations").get();

  for (const cartItem of cart) {
    const itemName = cartItem.name;
    const qtyRequested = cartItem.quantity || 1;

    // 🔎 Get max stock from global qtyMap or default to 1
    const stockAvailable = qtyMap[itemName]?.options?.slice(-1)[0] || 1;

    const bookedQtyPerDate = {};

    for (const doc of snapshot.docs) {
      const data = doc.data();
      if (!data.rentalDates || !data.cartItems) continue;

      const [bookedStartStr, bookedEndStr] = data.rentalDates.split(" to ");
      const bookedStart = new Date(bookedStartStr);
      const bookedEnd = new Date(bookedEndStr);

      if (start > bookedEnd || end < bookedStart) continue;

      for (const bookedItem of data.cartItems) {
        if (bookedItem.name !== itemName) continue;

        const bookedQty = bookedItem.quantity || 1;
        let d = new Date(bookedStart);
        while (d <= bookedEnd) {
          const key = d.toISOString().split("T")[0];
          bookedQtyPerDate[key] = (bookedQtyPerDate[key] || 0) + bookedQty;
          d.setDate(d.getDate() + 1);
        }
      }
    }

    // 🚫 Check for overbooking on each date
    let d = new Date(start);
    while (d <= end) {
      const key = d.toISOString().split("T")[0];
      const alreadyBooked = bookedQtyPerDate[key] || 0;
      if (alreadyBooked + qtyRequested > stockAvailable) {
        Swal.fire({
          icon: "error",
          title: "Item Overbooked",
          text: `${itemName} is overbooked on ${key}. Only ${stockAvailable - alreadyBooked} left.`,
        });
        return;
      }
      d.setDate(d.getDate() + 1);
    }
  }

  // ✅ Proceed with Telegram & Firestore save
  sendTelegramMessage(name, phone, location, rentalDates, startTime, endTime, paymentType, cart, totalAmount);

  await db.collection("reservations").add({
    name,
    phone,
    location,
    rentalDates,
    startTime,
    endTime,
    paymentType,
    cartItems: cart,
    amountPaid: Number(totalAmount),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  localStorage.removeItem("cart");
  updateCartCount && updateCartCount();

  Swal.fire({
    title: 'ORDER MADE',
    html: `
      <div style="font-size: 18px; font-weight: 500; color: #333; text-align: center;">
        WE WILL DELIVER THE ITEMS TO<br>
        <span style="color: #1a73e8; font-weight: 600;">${location}</span><br><br>
        ON <span style="color: #1a73e8; font-weight: 600;">${rentalDates}</span><br>
        AT <span style="color: #1a73e8; font-weight: 600;">${startTime}</span>
      </div>
    `,
    icon: 'success',
    iconColor: '#4caf50',
    background: '#f8f9fa',
    confirmButtonText: 'Awesome!',
    confirmButtonColor: '#1a73e8',
    customClass: {
      popup: 'swal2-rounded',
      title: 'swal2-title-custom',
      confirmButton: 'swal2-confirm-custom'
    }
  });
}


  // Telegram notification function
function sendTelegramMessage(name, phone, location, rentalDates, startTime, endTime, paymentType, cart, totalAmount) {
  const telegramBotToken = '7638261664:AAGm0MNVQxN0hlW1bhXBRf-kSRuMgRkCLC8'; // Replace!
  const chatId = '-1002734216867'; // Replace!

  let itemsSummary = cart.map(item => {
    const qty = item.quantity || 1;
    const days = item.days || 1;
    const total = (item.price * qty * days).toFixed(2);
    return `• ${item.name} (x${qty}, ${days} day${days > 1 ? 's' : ''}) = $${total}`;
  }).join('\n');

  const message = `
🛒 New Reservation

👤 Name: ${name}
📞 Phone: ${phone}
📍 Location: ${location}

📅 Dates: ${rentalDates}
⏰ Time: ${startTime} to ${endTime}
💳 Payment: ${paymentType}
💰 Amount Paid: $${totalAmount}

🧾 Cart Items:
${itemsSummary}
  `.trim();

  const url = `https://api.telegram.org/bot${telegramBotToken}/sendMessage`;

  fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      chat_id: chatId,
      text: message,
      parse_mode: 'Markdown'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.ok) {
      console.log('Telegram message sent!');
    } else {
      console.error('Telegram error:', data);
    }
  })
  .catch(error => console.error('Telegram fetch error:', error));
}

  function isBookingAvailable(newStart, newEnd, bookings) {
  // 1 hour buffer in milliseconds
  const buffer = 60 * 60 * 1000;

  for (let booking of bookings) {
    // Add 1hr buffer to the end of existing booking
    const bookingEndWithBuffer = new Date(booking.end.getTime() + buffer);

    // Check for overlap
    if (
      (newStart < bookingEndWithBuffer && newEnd > booking.start)
    ) {
      // Overlap detected
      return false;
    }
  }
  return true; // No overlap
  }
    
    function login() {
  const email = prompt('Enter admin email:');
  const password = prompt('Enter admin password:');

  firebase.auth().signInWithEmailAndPassword(email, password)
    .then(() => {
      window.location.href = 'dashboard.html';
    })
    .catch((error) => {
      let errorMessage = 'Authentication failed: ' + error.message;
      if (error.code === 'auth/wrong-password') {
        errorMessage = 'Incorrect password. Please try again.';
      } else if (error.code === 'auth/user-not-found') {
        errorMessage = 'No user found with this email. Please check and try again.';
      }
      alert(errorMessage);
    });
}

function toggleMenu() {
  const menu = document.getElementById('menu');
  menu.classList.toggle('show');
}

function closeMenu() {
  const menu = document.getElementById('menu');
  menu.classList.remove('show');
}

function loadGallery(containerId) {
  const galleryContainer = document.getElementById(containerId);
  galleryContainer.innerHTML = '';

  db.collection('gallery').onSnapshot((querySnapshot) => {
    const categories = {};

    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const imageUrl = data.url;
      const name = data.name || 'Unnamed';
      const price = data.price || 0;
      const category = data.category || 'Uncategorized';

      if (!categories[category]) {
        categories[category] = [];
      }
      categories[category].push({ imageUrl, name, price });
    });

    let galleryHTML = '';

    for (const category in categories) {
      galleryHTML += `
        <div class="gallery-category">
          <h3>${category}</h3>
          <div class="gallery-wrapper">
            <div class="gallery-grid" id="gallery-${category}"></div>
          </div>
        </div>
      `;

      const categoryContainer = document.getElementById(`gallery-${category}`);
      categories[category].forEach((item) => {
        categoryContainer.innerHTML += `
          <div class="product-card">
            <img src="${item.imageUrl}" alt="${item.name}">
            <div class="product-info">
              <div class="product-name">${item.name}</div>
              <div class="product-price">$${item.price.toFixed(2)}</div>
              <button onclick="addToCart('${item.name}', ${item.price}, '${item.imageUrl}')">Add to Cart</button>
            </div>
          </div>
        `;
      });
    }

    galleryContainer.innerHTML = galleryHTML;  // Efficiently inject the full HTML after building it
  });
}

window.onload = function() {
  loadGalleryByCategory('EVENT ITEMS');
  updateCartCount();

  // ✅ Instead of initializing flatpickr directly,
  // we now fetch booked dates and initialize it after
  fetchBookedDatesAndInitCalendar();
};

// Handle star rating UI
document.querySelectorAll('#starRating span').forEach(star => {
  star.addEventListener('click', () => {
    selectedRating = parseInt(star.getAttribute('data-value'));  // Set rating value on click
    // Update star colors based on selection
    document.querySelectorAll('#starRating span').forEach(s => {
      s.style.color = parseInt(s.getAttribute('data-value')) <= selectedRating ? '#f39c12' : '#ccc';
    });
  });
});

// Handle review form submission
document.getElementById('reviewForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const user = firebase.auth().currentUser;
  if (!user) {
    alert("You must be logged in to submit a review.");
    return;
  }

  const name = document.getElementById('reviewName').value.trim();
  const comment = document.getElementById('reviewComment').value.trim();
  const msg = document.getElementById('reviewSubmitMsg');

  // Check for required fields and star rating
  if (!name || !comment || selectedRating === 0) {
    msg.style.color = "red";
    msg.textContent = "Please fill all fields and select a star rating.";
    return;
  }

  try {
    // Add the review to Firestore
    await db.collection('reviews').add({
      name,
      comment,
      rating: selectedRating,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      uid: user.uid
    });

    // Update UI message and reset fields
    msg.style.color = "green";
    msg.textContent = "Thank you for your review!";
    document.getElementById('reviewForm').reset();
    selectedRating = 0;
    document.querySelectorAll('#starRating span').forEach(s => s.style.color = '#ccc');

    // Refresh reviews immediately after submission
    loadReviews(user);

  } catch (error) {
    console.error("Error submitting review:", error);
    msg.style.color = "red";
    msg.textContent = "Error submitting review.";
  }
});

// Function to load and display reviews
function loadReviews(user) {
  const container = document.getElementById('reviewsContainer');
  container.innerHTML = ''; // Clear any existing reviews

  db.collection('reviews').orderBy('timestamp', 'desc').get().then(snapshot => {
    if (snapshot.empty) {
      container.innerHTML = '<p>No reviews yet.</p>';
      return;
    }

    snapshot.forEach(doc => {
      const data = doc.data();
      const canDelete = user && data.uid === user.uid; // Check if the logged-in user can delete the review

      const reviewDiv = document.createElement('div');
      reviewDiv.style.borderBottom = '1px solid #ddd';
      reviewDiv.style.padding = '10px 0';

      // Display stars based on the rating
      const stars = '★'.repeat(data.rating) + '☆'.repeat(5 - data.rating);

      reviewDiv.innerHTML = `
        <strong>${data.name}</strong> <span style="color: #f39c12;">${stars}</span><br/>
        <p>${data.comment}</p>
      `;

      // Add delete button if the user can delete the review
      if (canDelete) {
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.style.backgroundColor = '#e74c3c';
        delBtn.style.color = 'white';
        delBtn.style.border = 'none';
        delBtn.style.padding = '5px 10px';
        delBtn.style.borderRadius = '4px';
        delBtn.style.cursor = 'pointer';

        delBtn.addEventListener('click', () => deleteReview(doc.id)); // Add delete logic

        reviewDiv.appendChild(delBtn); // Append the delete button
      }

      container.appendChild(reviewDiv);
    });
  }).catch(error => {
    console.error('Error loading reviews:', error);
    container.innerHTML = '<p>Error loading reviews.</p>';
  });
}

// Function to delete review
function deleteReview(docId) {
  const user = firebase.auth().currentUser;
  if (!user) {
    alert('You must be logged in to delete reviews.');
    return;
  }

  if (confirm("Are you sure you want to delete this review?")) {
    db.collection('reviews').doc(docId).get().then(doc => {
      if (doc.exists && doc.data().uid === user.uid) {
        db.collection('reviews').doc(docId).delete()
          .then(() => {
            alert('Review deleted.');
            loadReviews(user); // Reload reviews after deletion
          })
          .catch(error => {
            alert('Error deleting review: ' + error.message);
          });
      } else {
        alert("You can only delete your own reviews.");
      }
    });
  }
}

    function loadGalleryByCategory(categoryFilter) {
  const galleryContainer = document.getElementById('galleryDisplay');
  galleryContainer.innerHTML = '';

  const qtyMap = {
    "CHAIRS": {
      options: [10, 20, 50, 100, 200],
      prices: { 10: 30, 20: 55, 50: 120, 100: 200, 200: 300 }
    },
    "PLASTIC TABLE": {
      options: [1, 2, 4, 6],
      prices: { 1: 10, 2: 20, 4: 35, 6: 50 }
    },
    "Podium": {
      options: [1, 2, 3],
      prices: { 1: 15, 2: 28, 3: 40 }
    },
    "Plates": {
      options: [10, 20, 30, 50],
      prices: { 10: 10, 20: 18, 30: 25, 50: 35 }
    },
    "Lights": {
      options: [1, 5, 10],
      prices: { 1: 10, 5: 45, 10: 80 }
    },
    "Beach Umbrella": {
      options: [1, 2, 4],
      prices: { 1: 12, 2: 20, 4: 35 }
    },
    "Bluetooth Speaker": {
      options: [1, 2],
      prices: { 1: 30, 2: 55 }
    },
    "Tents": {
      options: [1, 2, 3],
      prices: { 1: 100, 2: 180, 3: 250 }
    },
    "Portable Bar": {
      options: [1, 2],
      prices: { 1: 50, 2: 90 }
    },
    "Outdoor Fan": {
      options: [1, 2, 4],
      prices: { 1: 15, 2: 25, 4: 40 }
    },
    "Warm Pan": {
      options: [2, 4, 6],
      prices: { 2: 10, 4: 18, 6: 25 }
    }
  };

  db.collection('gallery')
    .where('category', '==', categoryFilter)
    .get()
    .then((querySnapshot) => {
      if (querySnapshot.empty) {
        galleryContainer.innerHTML = `<p style="text-align:center;">No items found in "${categoryFilter}".</p>`;
        return;
      }

      galleryContainer.innerHTML = `
        <div class="gallery-category">
          <h3>${categoryFilter}</h3>
          ${categoryFilter === 'EVENT ITEMS' ? `
            <p style="margin-top: 3px; font-size: 18px; font-weight: bold; color: #6A0DAD; text-align: center;">
              DELIVERY ONLY. SETUP NOT INCLUDED!!
            </p>` : ''}
          <div class="gallery-wrapper">
            <div class="gallery-grid" id="gallery-${categoryFilter}"></div>
          </div>
        </div>
      `;

      const categoryContainer = document.getElementById(`gallery-${categoryFilter}`);

      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const imageUrl = data.url;
        const name = data.name || 'Unnamed';
        const itemId = name.replace(/\s+/g, '-');
        const firebasePrice = data.price || 0;

        if (!imageUrl || !name) return;

        let html = `
          <div class="product-card">
            <img src="${imageUrl}" alt="${name}">
            <div class="product-info">
              <div class="product-name">${name}</div>`;

        // Check if item is in qtyMap
        if (qtyMap[name]) {
          const quantityOptions = qtyMap[name].options;
          const quantityPrices = qtyMap[name].prices;
          const defaultQty = quantityOptions[0];
          const defaultPrice = quantityPrices[defaultQty] || 0;

          html += `
              <div class="product-price">
                Total: $<span id="price-${itemId}">${defaultPrice.toFixed(2)}</span>
              </div>
              <select id="qty-${itemId}" onchange="updateManualPrice('${itemId}', ${JSON.stringify(quantityPrices).replace(/"/g, '&quot;')})">
                ${quantityOptions.map(qty => `<option value="${qty}">${qty}</option>`).join('')}
              </select>`;
        } else {
          // Not in qtyMap — treat as fixed-price item
          html += `
              <div class="product-price">
                Price: $<span id="price-${itemId}">${firebasePrice.toFixed(2)}</span>
              </div>`;
        }

        if (qtyMap[name]) {
  html += `
    <button onclick="addToCartWithQty('${name}', 0, '${imageUrl}')">Add to Cart</button>
  `;
} else {
  html += `
    <button onclick="addToCart('${name}', ${firebasePrice}, '${imageUrl}')">Add to Cart</button>
  `;
}

html += `
  </div>
</div>`;

        categoryContainer.innerHTML += html;
      });
    })
    .catch((error) => {
      console.error("Error loading gallery:", error);
      galleryContainer.innerHTML = `<p style="text-align:center; color:red;">Error loading items. Please try again later.</p>`;
    });

  showSection('gallerySection');
}

  const restrictedCategories = ['BATHROOM', 'THRILL RIDES', 'CARS'];

        // Add fixed-price item to cart (used by Bathroom, Cars, Thrill Rides)
function addToCartWithQty(name, _, imageUrl) {
  const itemId = name.replace(/\s+/g, '-');
  const qtyElement = document.getElementById(`qty-${itemId}`);
  const priceElement = document.getElementById(`price-${itemId}`);

  if (!qtyElement || !priceElement) return;

  const qty = parseInt(qtyElement.value) || 1;
  const totalPriceDisplayed = parseFloat(priceElement.textContent.replace(/,/g, ''));
  const unitPrice = totalPriceDisplayed / qty;
  const days = 1;

  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  db.collection('gallery')
    .where('name', '==', name)
    .limit(1)
    .get()
    .then(snapshot => {
      if (snapshot.empty) return;

      const item = snapshot.docs[0].data();
      const category = item.category || '';
      const isRestricted = restrictedCategories.includes(category.toUpperCase());

      const exists = cart.find(i => i.name === name);

      if (exists && isRestricted) {
        showToast("YOU CAN ONLY ADD THIS ITEM ONCE", "error");
        return;
      }

      if (exists) {
        exists.quantity = qty;
        exists.price = unitPrice;
        exists.days = days;
        exists.totalPrice = unitPrice * qty * days;
      } else {
        cart.push({
          name,
          price: unitPrice,
          imageUrl,
          quantity: qty,
          totalPrice: unitPrice * qty * days,
          days,
          category
        });
      }

      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartCount();
      showToast("ADDED TO CART", "success");
    });
}



// Update price when quantity is selected
function updateManualPrice(itemId, priceMap) {
  const qty = document.getElementById(`qty-${itemId}`).value;
  const price = priceMap[qty] || 0;
  document.getElementById(`price-${itemId}`).textContent = price.toFixed(2);
}

// Update price for multi-quantity items
function updatePrice(itemId, basePrice) {
  const qty = parseInt(document.getElementById(`qty-${itemId}`).value) || 1;
  const total = qty * basePrice;
  document.getElementById(`price-${itemId}`).textContent = total.toFixed(2);
}

// Show section (Switch active sections)
function showSection(sectionId) {
  document.querySelectorAll('.content-section').forEach(section => {
    section.classList.remove('active');
  });
  document.getElementById(sectionId).classList.add('active');
}

// Logout user
function logoutUser() {
  firebase.auth().signOut().then(() => {
    window.location.href = 'login.html';
  });
}

// Add item to the cart
function addToCart(name, price, imageUrl) {
  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  db.collection('gallery')
    .where('name', '==', name)
    .limit(1)
    .get()
    .then(snapshot => {
      if (snapshot.empty) return;

      const item = snapshot.docs[0].data();
      const category = item.category || '';
      const isRestricted = restrictedCategories.includes(category.toUpperCase());

      const exists = cart.find(i => i.name === name);

      // ❌ Block if item exists and it's from a restricted category
      if (exists && isRestricted) {
        showToast("YOU CAN ONLY ADD THIS ITEM ONCE", "error");
        return;
      }

      // ✅ Add new item
      if (!exists) {
        cart.push({ name, price, imageUrl, quantity: 1, category });
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount();
        showToast('ADDED TO CART', 'success');
      } else {
        // ✅ If not restricted, allow quantity to increase
        exists.quantity += 1;
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount();
        showToast("ADDED TO CART", "success");
      }
    });
}


// Update cart item count
function updateCartCount() {
  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  const count = cart.reduce((total, item) => total + item.quantity, 0);
  document.getElementById('cart-count').textContent = count;
}

// Update rental duration and prices
function updateRentalDuration() {
  const rangeInput = document.getElementById('rentalDateRange');
  const dates = rangeInput.value.split(' to ');

  // If only one date is selected, treat it as a 1-day rental
  if (dates.length === 1 && dates[0]) {
    dates[1] = dates[0]; // Duplicate it as both start and end
  }

  if (dates.length !== 2 || !dates[0] || !dates[1]) return;

  const start = new Date(dates[0]);
  const end = new Date(dates[1]);
  const msPerDay = 1000 * 60 * 60 * 24;

  start.setHours(0, 0, 0, 0);
  end.setHours(0, 0, 0, 0);

  const days = Math.round((end - start) / msPerDay) + 1;

  if (isNaN(days) || days < 1) {
    alert("Please select a valid rental date range.");
    return;
  }

  console.log(`Rental Days: ${days}`);

  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  cart.forEach(item => {
    item.days = days;
    item.totalPrice = item.price * item.quantity * days;
  });

  localStorage.setItem('cart', JSON.stringify(cart));
  viewCart();
}

  function initializeDatepicker() {
  flatpickr("#rentalDateRange", {
    mode: "range",
    dateFormat: "Y-m-d",
    minDate: "today",
    disable: bookedDates,
    onClose: function(selectedDates, dateStr, instance) {
      const input = document.getElementById("rentalDateRange");

      if (selectedDates.length === 1) {
        const onlyDate = selectedDates[0];
        const formatted = instance.formatDate(onlyDate, "Y-m-d");
        input.value = `${formatted} to ${formatted}`;
        updateRentalDuration();
      } else if (selectedDates.length === 2) {
        updateRentalDuration();
      }
    }
  });
}

function viewCart() {
  const modal = document.getElementById('cartModal');
  const container = document.getElementById('cartItemsContainer');
  const totalElem = document.getElementById('cartTotal');
  container.innerHTML = ''; // Clear the cart container

  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  if (cart.length === 0) {
    container.innerHTML = '<p>Your cart is empty.</p>';
    totalElem.textContent = '';
  } else {
    let total = 0;

    cart.forEach((item, index) => {
  const days = item.days || 1;
  const quantity = item.quantity || 1;
  const unitPrice = item.price || 0;

  const itemTotal = unitPrice * quantity * days;
  total += itemTotal;

  const itemDiv = document.createElement('div');
  itemDiv.style.display = 'flex';
  itemDiv.style.alignItems = 'center';
  itemDiv.style.justifyContent = 'space-between';
  itemDiv.style.padding = '8px 0';
  itemDiv.style.borderBottom = '1px solid #eee';

  const img = document.createElement('img');
  img.src = item.imageUrl;
  img.alt = item.name;
  img.style.width = '50px';
  img.style.height = '50px';
  img.style.objectFit = 'cover';
  img.style.borderRadius = '6px';
  img.style.marginRight = '8px';

  const infoDiv = document.createElement('div');
  infoDiv.style.flexGrow = '1';
  infoDiv.style.display = 'flex';
  infoDiv.style.alignItems = 'center';
  infoDiv.style.justifyContent = 'space-between';

  const nameSpan = document.createElement('span');
  nameSpan.textContent = item.name;

  const quantityText = document.createElement('span');
  quantityText.textContent = `Qty: ${quantity}`;
  quantityText.style.marginLeft = '10px';

  const priceSpan = document.createElement('span');
  priceSpan.textContent = `$${itemTotal.toLocaleString(undefined, { minimumFractionDigits: 2 })} (${days} day${days > 1 ? 's' : ''})`;
  priceSpan.style.marginLeft = '10px';
  priceSpan.style.fontWeight = 'bold';

  const controlsDiv = document.createElement('div');
  controlsDiv.style.display = 'flex';
  controlsDiv.style.alignItems = 'center';

  const removeBtn = document.createElement('button');
  removeBtn.textContent = '✖';
  removeBtn.style.color = 'red';
  removeBtn.style.marginLeft = '8px';
  removeBtn.onclick = () => removeItem(index);

  controlsDiv.appendChild(quantityText);
  controlsDiv.appendChild(removeBtn);

  infoDiv.appendChild(nameSpan);
  infoDiv.appendChild(priceSpan);

  itemDiv.appendChild(img);
  itemDiv.appendChild(infoDiv);
  itemDiv.appendChild(controlsDiv);

  container.appendChild(itemDiv);
});

    totalElem.textContent = `Total: $${total.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
  }

  modal.style.display = 'block'; // Show the cart modal

// ⬇️ Initialize or re-initialize flatpickr when modal becomes visible
setTimeout(() => {
  flatpickr("#rentalDateRange", {
    mode: "range",
    dateFormat: "Y-m-d",
    minDate: "today",
    disable: bookedDates,
    onClose: function(selectedDates, dateStr, instance) {
      const input = document.getElementById("rentalDateRange");

      if (selectedDates.length === 1) {
        const onlyDate = selectedDates[0];
        const formatted = instance.formatDate(onlyDate, "Y-m-d");
        input.value = `${formatted} to ${formatted}`;
        updateRentalDuration();
      } else if (selectedDates.length === 2) {
        updateRentalDuration();
      }
    }
  });
}, 100); // Short delay ensures modal is visible before attaching

}

function removeItem(index) {
  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  if (cart[index]) {
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
    viewCart();
  }
}

    function showToast(message = "ADDED TO CART", type = "success") {
  const toast = document.getElementById('toast');
  toast.textContent = message;

  // Color by type
  toast.style.backgroundColor = type === "error" ? "#dc3545" : "#28a745"; // red or green

  toast.style.display = 'block';
  toast.style.opacity = '1';

  setTimeout(() => {
    toast.style.opacity = '0';
  }, 2000);

  setTimeout(() => {
    toast.style.display = 'none';
  }, 2500);
}

  document.getElementById("closeCheckoutBtn").addEventListener("click", function () {
    document.getElementById("cartModal").style.display = "none";
  });

  document.getElementById("payNowBtn").addEventListener("click", function () {
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  if (cart.length === 0) {
    Swal.fire("Empty Cart", "Please add items before proceeding.", "error");
    return;
  }

  let total = 0;
  cart.forEach(item => {
    const days = item.days || 1;
    const qty = item.quantity || 1;
    total += item.price * qty * days;
  });

  Swal.fire({
    title: "Complete Your Payment",
    html: `
      <p><b>Total:</b> J$${total.toLocaleString()}</p>
      <p>Please transfer funds to:</p>
      <p>
        <b>Bank:</b> YOUR BANK NAME<br>
        <b>Account Name:</b> YOUR ACCOUNT NAME<br>
        <b>Account Number:</b> YOUR ACCOUNT #<br>
        <b>Type:</b> Savings / Chequing
      </p>
      <p>After sending, click confirm to place your order.</p>
    `,
    showCancelButton: true,
    confirmButtonText: "Confirm Order",
    cancelButtonText: "Cancel"
  }).then(result => {
    if (result.isConfirmed) {
      completeBooking(); // <-- sends order to Telegram & Firestore
    }
  });
});


  </script>
  </body>
  </html>
