<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VTEC RENTALS.CA</title>

  <!-- UI libs -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Zilla+Slab:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Zilla Slab', serif; margin: 0; padding: 0; background-color: #FFFF; }
    .header-bar { position: fixed; top: 0; left: 0; right: 0; height: 48px; background-color: #343a40; display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .header-title { font-family: 'Zilla Slab', serif; font-size: 28px; font-weight: bold; background: linear-gradient(90deg, #6A0DAD, #007BFF, #2E8B57, #6A0DAD); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 2px 2px 8px rgba(0,0,0,0.3); white-space: nowrap; text-align: center; }
    .menu-button { position: absolute; left: 0; top: 50%; transform: translateY(-50%); background-color: #6A0DAD; color: #FFF8DC; border: none; border-radius: 0; cursor: pointer; height: 48px; width: 45px; display: flex; align-items: center; justify-content: center; font-size: 22px; padding: 0; }
    .menu { position: fixed; top: 48px; left: 0; width: 150px; background-color: rgba(0, 0, 0, 0.8); color: #E6B422; padding: 20px; transform: translateX(-100%); transition: transform 0.3s ease; height: auto; min-height: 100px; z-index: 999; }
    .menu.show { transform: translateX(0); }
    .menu a { display: block; color: white; margin-bottom: 15px; text-decoration: none; font-weight: bold; cursor: pointer; }
    h1 { text-align: center; color: #6c757d; margin-top: 80px; }
    form { max-width: 400px; margin: 0 auto; background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    form input, form select, form button { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    form button { background-color: #6200ea; color: white; border: none; cursor: pointer; font-weight: bold; }
    form button:hover { background-color: #3700b3; }
    #bookingMessage { text-align: center; font-weight: bold; color: green; margin-top: 20px; }
    .gallery-category { margin-top: 40px; }
    .gallery-category h3 { text-align: center; margin-bottom: 15px; font-size: 22px; color: #6200ea; text-transform: uppercase; }
    .gallery-wrapper { max-width: 1000px; margin: 0 auto; padding: 0 10px; }
    .gallery-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px; }
    @media (min-width: 768px) { .gallery-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 600px) { #card-element, .payment-button { width: 100%; max-width: 90%; } }
    .gallery-grid img { width: 100%; border-radius: 10px; box-shadow: 0 0 8px rgba(0,0,0,0.1); height: 230px; object-fit: cover; }
    .content-section { display: none; }
    .content-section.active { display: block; }
    .menu a.admin-button { background-color: #6A0DAD; color: white; padding: 10px 20px; border-radius: 8px; font-weight: bold; display: block; margin: 50px auto 0; cursor: pointer; transition: background-color 0.3s ease; text-align: center; width: fit-content; }
    .menu a.admin-button:hover { background-color: #3700b3; }
    .add-to-cart-button { position: absolute; right: 0; top: 50%; transform: translateY(-50%); background-color: #6A0DAD; color: red; border: none; padding: 0; border-radius: 0; cursor: pointer; height: 48px; width: 45px; display: flex; align-items: center; justify-content: center; font-size: 22px; text-decoration: none; }
    .separator-line { border-bottom: 2px solid purple; margin: 20px 0; }
    .product-card { background: #8c9b9f; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 10px; text-align: center; }
    .product-card img { width: 100%; height: 180px; object-fit: cover; border-radius: 6px; margin-bottom: 8px; }
    .product-info { margin-top: 5px; }
    .product-name { font-weight: bold; margin-bottom: 4px; }
    .product-price { color: #6200ea; margin-bottom: 6px; }
    .product-card button { background-color: #6A0DAD; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }

    /* Cart Modal */
    #cartModal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); display: none; z-index: 2000; }
    #cartModal > div { background: #8c9b9f; max-width: 320px; margin: 80px auto; border-radius: 12px; padding: 15px 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-family: 'Zilla Slab', serif; max-height: 70vh; overflow-y: auto; }
    input, textarea { width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }

    #cartModal h2 { margin-top: 0; text-align: center; color: #6A0DAD; }
    #cartItemsContainer > div { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
    #cartItemsContainer img { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; margin-right: 10px; }
    #cartItemsContainer span { font-weight: normal; }
    #cartItemsContainer div > div { display: flex; justify-content: space-between; align-items: center; flex-grow: 1; }

    #cartButtons { display: flex; justify-content: space-between; margin-top: 15px; }
    #cartButtons button { flex: 1; padding: 10px 0; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 0 5px; transition: background-color 0.3s ease; }
    #checkoutBtn { background-color: #6200ea; color: white; }
    #checkoutBtn:hover { background-color: #3700b3; }
    #closeCartBtn { background-color: #ccc; color: black; }
    #closeCartBtn:hover { background-color: #999; }

    input.error { border: 2px solid red; background-color: #fff4f4; }

    .close-btn { padding: 8px 16px; font-size: 14px; cursor: pointer; border: none; background-color: #bbb; color: white; border-radius: 8px; margin-top: 20px; margin: 10px auto; width: fit-content; }
    .close-btn:hover { background-color: #999; }

    @media (max-width: 600px) {
      .payment-modal { padding: 20px; }
      .payment-button { padding: 10px 15px; font-size: 14px; }
    }

    /* Toast */
    #toast { display: none; position: fixed; bottom: 30px; right: 30px; background-color: #28a745; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 9999; font-weight: bold; transition: opacity 0.3s ease; }

    .swal2-popup.swal2-rounded { border-radius: 20px; padding: 30px; text-align: center; }
    .swal2-title-custom { font-size: 28px; font-family: 'Poppins', sans-serif; font-weight: 700; color: #2e7d32; text-align: center; }
    .swal2-confirm-custom { background-color: #1a73e8 !important; color: white !important; font-size: 16px; border-radius: 8px !important; padding: 10px 20px; }

  </style>
</head>

<body>

  <div class="header-bar">
    <button class="menu-button" onclick="toggleMenu()">‚ò∞</button>
    <div class="header-title">VTEC RENTALS.CA</div>

    <div class="add-to-cart-button" onclick="viewCart()" style="display:flex; flex-direction:column; align-items:center; background:#6A0DAD; border:none; cursor:pointer;">
      <span style="font-size:20px;">üõí</span>
      <span id="cart-count" style="font-size:15px; color:red; margin-top:2px;">0</span>
    </div>
  </div>

  <!-- Gallery Section -->
  <div id="gallerySection" class="content-section active">
    <h2 style="text-align:center; margin-top:60px;"></h2>
    <div id="galleryDisplay"></div>
  </div>

  <!-- Menu -->
  <div class="menu" id="menu">
    <a onclick="loadGalleryByCategory('EVENT ITEMS'); closeMenu();" href="javascript:void(0);">üéâ EVENT ITEMS</a>
    <a onclick="loadGalleryByCategory('THRILL RIDES'); closeMenu();" href="javascript:void(0);">üèÅ THRILL RIDES</a>
    <a onclick="loadGalleryByCategory('CARS'); closeMenu();" href="javascript:void(0);">üöò MOTORCARS</a>
    <a onclick="loadGalleryByCategory('BATHROOM'); closeMenu();" href="javascript:void(0);">üöª BATHROOM</a>
    <a onclick="showSection('reviewsSection'); closeMenu();" href="javascript:void(0);">‚≠êÔ∏è REVIEWS</a>
    <a onclick="logoutUser(); closeMenu();" style="display:block; text-align:center; margin:10px auto; padding:10px 20px; background-color:red; color:white; border-radius:6px; cursor:pointer; text-decoration:none; width:80%; font-weight:bold;" href="javascript:void(0);">LOGOUT</a>
    <a onclick="login(); closeMenu();" class="admin-button" style="display:block; text-align:center; margin:10px auto; padding:10px 20px; background-color:#6200ea; color:white; border-radius:6px; text-decoration:none; width:80%; font-weight:bold;" href="javascript:void(0);">ADMIN</a>
  </div>

  <!-- Reviews -->
  <div id="reviewsSection" class="content-section" style="padding-top: 34px; background-color: black; color: white;">
    <div id="reviewFormContainer" style="max-width:500px; margin:10px auto 20px; background-color:#6A0DAD; padding:5px; border-radius:10px; color:black;">
      <form id="reviewForm" style="text-align:center;">
        <input type="text" id="reviewName" placeholder="Your Name" required style="width:100%; padding:8px; margin-bottom:6px; border-radius:6px; border:1px solid #555; background-color:#fff; color:black; box-sizing:border-box;" />
        <textarea id="reviewComment" placeholder="Write your review..." required style="width:100%; height:60px; padding:8px; margin-bottom:6px; border-radius:6px; border:1px solid #555; background-color:#fff; color:black; box-sizing:border-box;"></textarea>
        <div id="starRating" style="font-size:22px; margin-bottom:6px; cursor:pointer; color:#ccc; letter-spacing:-2px;">
          <span data-value="1">‚òÖ</span><span data-value="2">‚òÖ</span><span data-value="3">‚òÖ</span><span data-value="4">‚òÖ</span><span data-value="5">‚òÖ</span>
        </div>
        <button type="submit" style="background-color:#6200ea; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">Submit Review</button>
      </form>
    </div>

    <h1 style="text-align:center; color:#9b59b6; margin-top:5px; margin-bottom:10px;">REVIEWS</h1>
    <p id="reviewSubmitMsg" style="text-align:center; color:#7fff7f; margin-top:0;"></p>
    <div id="reviewsContainer" style="max-width:600px; margin:0 auto; color:white;"></div>
  </div>

  <!-- Cart Modal -->
  <div id="cartModal" style="display:none;">
    <div style="position:relative;">
      <button id="closeCheckoutBtn" style="position:absolute; top:10px; right:15px; font-size:20px; background:none; border:none; color:#6A0DAD; cursor:pointer;">‚úñ</button>

      <div>
        <h2>YOUR CART</h2>

        <div style="margin-bottom:10px;">
          <label for="customerName"><strong>Your Name:</strong></label>
          <input type="text" id="customerName" placeholder="Enter your name" required />
        </div>

        <div style="margin-bottom:15px;">
          <label for="customerPhone"><strong>Phone Number:</strong></label>
          <input type="tel" id="customerPhone" placeholder="Enter phone number" required />
        </div>

        <div style="margin-bottom:15px;">
          <label for="rentalDateRange"><strong>Select Rental Dates:</strong></label>
          <input id="rentalDateRange" placeholder="Select start and end date" />
        </div>

        <div style="display:flex; gap:10px; margin-bottom:10px;">
          <div style="flex:1;">
            <label for="startTime">Start Time:</label>
            <input type="time" id="startTime" />
          </div>
          <div style="flex:1;">
            <label for="endTime">End Time:</label>
            <input type="time" id="endTime" />
          </div>
        </div>

        <div style="margin-bottom:15px;">
          <label for="customerLocation"><strong>Location:</strong></label>
          <input type="text" id="customerLocation" placeholder="Enter delivery location" required />
        </div>

        <!-- üîî Availability warnings appear here -->
<div id="cartWarnings" style="color:red; font-weight:bold; margin:10px 0;"></div>

<!-- Cart items -->
<div id="cartItemsContainer"></div>

<!-- Cart total -->
<div id="cartTotal" style="text-align:right; font-weight:bold; margin-top:10px;"></div>

<!-- Place order button -->
<div id="cartButtons">
  <button 
    id="placeOrderBtn" 
    onclick="completeBooking()" 
    style="background-color:#6A0DAD; color:white; border:none; padding:10px; border-radius:8px; font-size:16px; font-weight:bold; cursor:pointer;">
    PLACE ORDER
  </button>
</div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" style="display:none; position:fixed; bottom:30px; right:30px; background-color:#28a745; color:white; padding:12px 20px; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.1); z-index:9999; font-weight:bold; transition:opacity 0.3s ease;">Added to cart</div>

<script>
'use strict';

/* ===================== Firebase ===================== */
let currentUser = null;

const firebaseConfig = {
  apiKey: "AIzaSyDccI-TdbCXAJr6CD77X4yOUOfezef7Oks",
  authDomain: "delivery-login-3a084.firebaseapp.com",
  projectId: "delivery-login-3a084",
  storageBucket: "delivery-login-3a084.firebasestorage.app",
  messagingSenderId: "201998621677",
  appId: "1:201998621677:web:b51c3aeb2debe18b4aa5e4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

firebase.auth().onAuthStateChanged(user => {
  currentUser = user || null;
}); // ‚úÖ CLOSE the listener properly

  /* ===================== Inventory Settings ===================== */
const qtyMap = {
  "CHAIRS": {
    options: [1, 2, 5, 10, 20],  // bundles you rent out
    prices: {
      1: 500,     // price if they take 1
      2: 900,     // price if they take 2
      5: 2000,
      10: 3500,
      20: 6000
    }
  },
  "Table": {
    options: [1, 2, 4],
    prices: {
      1: 800,
      2: 1500,
      4: 2800
    }
  },
  "Portable Toilet": {
    options: [1, 2, 3],
    prices: {
      1: 3000,
      2: 5800,
      3: 8000
    }
  }
};

/* Items that can only be booked once per order (optional) */
const restrictedCategories = ["BATHROOM"];


/* ===================== Globals / Helpers ===================== */
let bookedDates = [];       // for disabling already-booked dates
let selectedRating = 0;     // review stars
// Use the qtyMap and restrictedCategories defined above. Do NOT redeclare them here.

function formatJMD(amount) {
  return 'JMD $' + Number(amount).toLocaleString('en-JM', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function toggleMenu(){ document.getElementById('menu').classList.toggle('show'); }
function closeMenu(){ document.getElementById('menu').classList.remove('show'); }

function showSection(sectionId) {
  document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
  document.getElementById(sectionId).classList.add('active');
}

function login() {
  const email = prompt('Enter admin email:');
  const password = prompt('Enter admin password:');
  if (!email || !password) return;
  firebase.auth().signInWithEmailAndPassword(email, password)
    .then(() => { window.location.href = 'dashboard.html'; })
    .catch((error) => {
      let msg = 'Authentication failed: ' + error.message;
      if (error.code === 'auth/wrong-password') msg = 'Incorrect password. Please try again.';
      else if (error.code === 'auth/user-not-found') msg = 'No user found with this email. Please check and try again.';
      alert(msg);
    });
}

function logoutUser() {
  firebase.auth().signOut()
    .then(() => alert('Logged out.'))
    .catch(err => alert('Logout error: ' + err.message));
}

/* ===================== Calendar (Booked Dates) ===================== */
function fetchBookedDatesAndInitCalendar() {
  bookedDates = [];
  db.collection("reservations").get().then(snapshot => {
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.rentalDates) {
        const range = String(data.rentalDates).split(" to ");
        if (range.length === 2) {
          const start = new Date(range[0]);
          const end = new Date(range[1]);
          if (isNaN(start) || isNaN(end)) return;
          let current = new Date(start);
          while (current <= end) {
            bookedDates.push(current.toISOString().split('T')[0]);
            current.setDate(current.getDate() + 1);
          }
        }
      }
    });
  })
  .catch(err => console.error('Error loading booked dates:', err))
  .finally(() => initializeDatepicker()); // ‚úÖ always run
}

function initializeDatepicker() {
  flatpickr("#rentalDateRange", {
    mode: "range",
    dateFormat: "Y-m-d",
    minDate: "today",
    disable: [], // allow all dates
    onClose: function(selectedDates, dateStr, instance) {
      const input = document.getElementById("rentalDateRange");
      if (selectedDates.length === 1) {
        const onlyDate = selectedDates[0];
        const formatted = instance.formatDate(onlyDate, "Y-m-d");
        input.value = `${formatted} to ${formatted}`;
      } else if (selectedDates.length === 2) {
        const formattedStart = instance.formatDate(selectedDates[0], "Y-m-d");
        const formattedEnd = instance.formatDate(selectedDates[1], "Y-m-d");
        input.value = `${formattedStart} to ${formattedEnd}`;
      }
      updateRentalDuration();
    }
  });
}

function getRentalDayCount() {
  const value = (document.getElementById("rentalDateRange")?.value || "").trim();
  if (!value || !value.includes(" to ")) return 1;
  const [startStr, endStr] = value.split(" to ");
  const start = new Date(startStr);
  const end = new Date(endStr);
  if (isNaN(start) || isNaN(end)) return 1;
  const MS_PER_DAY = 24 * 60 * 60 * 1000;
  const raw = Math.ceil((end - start) / MS_PER_DAY) + 1; // inclusive
  return Math.max(1, raw);
}

function getCartTotal() {
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  const days = getRentalDayCount();
  let total = 0;
  cart.forEach(item => {
    const qty = item.quantity || 1;
    const price = Number(item.price) || 0;
    total += price * qty * days;
  });
  return Number(total.toFixed(2));
}

/* ===================== Order: Firestore + Telegram ===================== */
async function completeBooking() {
  try {
    const name = (document.getElementById("customerName")?.value || "").trim();
    const phone = (document.getElementById("customerPhone")?.value || "").trim();
    const location = (document.getElementById("customerLocation")?.value || "").trim();
    const rentalDates = (document.getElementById("rentalDateRange")?.value || "").trim();
    const startTime = (document.getElementById("startTime")?.value || "").trim();
    const endTime = (document.getElementById("endTime")?.value || "").trim();
    const paymentType = "Pay on Delivery";

    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    if (cart.length === 0) {
      Swal.fire({ icon: "info", title: "Cart is empty", text: "Add items before placing an order." });
      return;
    }

    if (!rentalDates.includes(" to ")) {
      Swal.fire({ icon: "error", title: "Invalid dates", text: "Please select a valid rental date range." });
      return;
    }
    const [startStr, endStr] = rentalDates.split(" to ");
    const start = new Date(startStr);
    const end = new Date(endStr);
    if (isNaN(start) || isNaN(end)) {
      Swal.fire({ icon: "error", title: "Invalid dates", text: "Please select a valid rental date range." });
      return;
    }

    // üö´ Block if warnings exist
    if (cartHasWarnings) {
      Swal.fire({
        icon: "error",
        title: "Stock Issue",
        text: "Some items in your cart are overbooked. Please adjust your cart before placing the order."
      });
      return;
    }

    // --- calculate total ---
    const days = getRentalDayCount();
    let totalAmount = 0;
    for (const item of cart) {
      const qty = item.quantity || 1;
      const price = Number(item.price) || 0;
      totalAmount += price * qty * days;
    }
    totalAmount = Number(totalAmount.toFixed(2));

    
    /* ===================== Save to Firestore ===================== */
    let firestoreError = null;
    try {
      await db.collection("reservations").add({
        name, phone, location,
        rentalDates, startTime, endTime,
        paymentType,
        cartItems: cart,
        totalAmount,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      console.log("‚úÖ Saved to Firestore");
    } catch (err) {
      console.error("‚ùå Firestore save failed:", err);
      firestoreError = err;
    }

    /* ===================== Always Send Telegram ===================== */
    try {
      await sendTelegramMessage(
        name, phone, location, rentalDates,
        startTime, endTime, paymentType,
        cart, totalAmount
      );
      console.log("‚úÖ Telegram sent");
    } catch (tgErr) {
      console.error("‚ùå Telegram send failed:", tgErr);
      Swal.fire({ icon: "error", title: "Telegram Failed", text: "Order saved, but Telegram message didn‚Äôt send." });
      return;
    }

    // --- Success ---
    localStorage.removeItem("cart");
    updateCartCount();
    if (document.getElementById("cartModal")) {
      document.getElementById("cartModal").style.display = "none";
    }

    Swal.fire({
      title: firestoreError ? "ORDER MADE (Firestore Failed)" : "ORDER MADE",
      text: firestoreError ? "Your order went through, but DB didn‚Äôt save." : "We got your booking!",
      icon: "success",
      confirmButtonColor: "#1a73e8"
    });

  } catch (err) {
    console.error("‚ùå completeBooking crashed:", err);
    Swal.fire({ icon: "error", title: "Oops", text: "Unexpected error placing the order." });
  }
}


/* Telegram: simple form POST to avoid CORS preflight */
function sendTelegramMessage(name, phone, location, rentalDates, startTime, endTime, paymentType, cart, totalAmount) {
  const telegramBotToken = '7638261664:AAGm0MNVQxN0hlW1bhXBRf-kSRuMgRkCLC8'; // keep secret server-side in production
  const chatId = '-1002734216867'; // ensure the bot is an admin/member of this chat

  const days = getRentalDayCount();
  const itemsSummary = cart.map(item => {
    const qty = item.quantity || 1;
    const price = Number(item.price) || 0;
    const lineTotal = Number((price * qty * days).toFixed(2));
    return `‚Ä¢ ${item.name} (x${qty}, ${days} day${days > 1 ? 's' : ''}) = ${formatJMD(lineTotal)}`;
  }).join('\n');

  const message =
`üõí New Reservation

üë§ Name: ${name}
üìû Phone: ${phone}
üìç Location: ${location}

üìÖ Dates: ${rentalDates}
‚è∞ Time: ${startTime} to ${endTime}
üí≥ Payment: ${paymentType}
üí∞ Total: ${formatJMD(totalAmount)}

üßæ Cart Items:
${itemsSummary}`;

  const url = `https://api.telegram.org/bot${telegramBotToken}/sendMessage`;
  const body = new URLSearchParams();
  body.append('chat_id', chatId);
  body.append('text', message);
  body.append('disable_web_page_preview', 'true');

  fetch(url, { method: 'POST', body })
    .then(() => console.log('Telegram message: sent (request dispatched)'))
    .catch(err => console.error('Telegram fetch error:', err));
}

/* ===================== Gallery / Cart ===================== */
function loadGalleryByCategory(categoryFilter) {
  const galleryContainer = document.getElementById('galleryDisplay');
  galleryContainer.innerHTML = '';

  db.collection('gallery')
    .where('category', '==', categoryFilter)
    .get()
    .then((querySnapshot) => {
      if (querySnapshot.empty) {
        galleryContainer.innerHTML = `<p style="text-align:center;">No items found in "${categoryFilter}".</p>`;
        return;
      }

      galleryContainer.innerHTML = `
        <div class="gallery-category">
          <h3>${categoryFilter}</h3>
          ${categoryFilter === 'EVENT ITEMS' ? `
            <p style="margin-top:3px; font-size:18px; font-weight:bold; color:#6A0DAD; text-align:center;">
              DELIVERY ONLY. SETUP NOT INCLUDED!!
            </p>` : ''}
          <div class="gallery-wrapper">
            <div class="gallery-grid" id="gallery-${categoryFilter}"></div>
          </div>
        </div>`;

      const categoryContainer = document.getElementById(`gallery-${categoryFilter}`);

      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const imageUrl = data.url;
        const name = data.name || 'Unnamed';
        const itemId = name.replace(/\s+/g, '-');
        const firebasePrice = Number(data.price) || 0;
        if (!imageUrl || !name) return;

        let html = `
          <div class="product-card">
            <img src="${imageUrl}" alt="${name}">
            <div class="product-info">
              <div class="product-name">${name}</div>`;

        if (qtyMap[name]) {
          const quantityOptions = qtyMap[name].options;
          const quantityPrices = qtyMap[name].prices;
          const defaultQty = quantityOptions[0];
          const defaultPrice = quantityPrices[defaultQty] || 0;

          html += `
            <div class="product-price">Total: <span id="price-${itemId}">${formatJMD(defaultPrice)}</span></div>
            <select id="qty-${itemId}" onchange="updateManualPrice('${name}', '${itemId}')">
              ${quantityOptions.map(qty => `<option value="${qty}">${qty}</option>`).join('')}
            </select>
            <button onclick="addToCartWithQty('${name}', '${imageUrl}')">Add to Cart</button>`;
        } else {
          html += `
            <div class="product-price">Price: <span id="price-${itemId}">${formatJMD(firebasePrice)}</span></div>
            <button onclick="addToCart('${name}', ${firebasePrice}, '${imageUrl}')">Add to Cart</button>`;
        }

        html += `</div></div>`;
        categoryContainer.innerHTML += html;
      });
    })
    .catch((error) => {
      console.error("Error loading gallery:", error);
      galleryContainer.innerHTML = `<p style="text-align:center; color:red;">Error loading items. Please try again later.</p>`;
    });

  showSection('gallerySection');
}

function updateManualPrice(itemName, itemId) {
  const qty = Number(document.getElementById(`qty-${itemId}`).value) || 1;
  const priceMap = qtyMap[itemName]?.prices || {};
  const price = Number(priceMap[qty]) || 0;
  document.getElementById(`price-${itemId}`).textContent = formatJMD(price);
}

async function addToCart(item) {
  try {
    const rentalDates = (document.getElementById("rentalDateRange")?.value || "").trim();
    if (!rentalDates.includes(" to ")) {
      Swal.fire({ icon: "info", title: "Select Dates", text: "Please select rental dates first." });
      return;
    }

    const [startStr, endStr] = rentalDates.split(" to ");
    const start = new Date(startStr);
    const end = new Date(endStr);
    if (isNaN(start) || isNaN(end)) {
      Swal.fire({ icon: "error", title: "Invalid Dates", text: "Please pick valid rental dates." });
      return;
    }

    const stockAvailable = (qtyMap?.[item.name]?.options?.slice(-1)?.[0]) || 1;

    // üîé Check existing reservations for this item
    const snapshot = await db.collection("reservations").get();
    let bookedQtyPerDate = {};

    snapshot.forEach(doc => {
      const data = doc.data();
      if (!data.rentalDates || !data.cartItems) return;

      const [bookedStartStr, bookedEndStr] = String(data.rentalDates).split(" to ");
      const bookedStart = new Date(bookedStartStr);
      const bookedEnd = new Date(bookedEndStr);
      if (isNaN(bookedStart) || isNaN(bookedEnd)) return;
      if (start > bookedEnd || end < bookedStart) return;

      for (const bookedItem of data.cartItems) {
        if (bookedItem.name !== item.name) continue;
        const bookedQty = bookedItem.quantity || 1;
        let d = new Date(bookedStart);
        while (d <= bookedEnd) {
          const key = d.toISOString().split("T")[0];
          bookedQtyPerDate[key] = (bookedQtyPerDate[key] || 0) + bookedQty;
          d.setDate(d.getDate() + 1);
        }
      }
    });

    // üîé Get max already booked across requested range
    let maxBooked = 0;
    let d = new Date(start);
    while (d <= end) {
      const key = d.toISOString().split("T")[0];
      maxBooked = Math.max(maxBooked, bookedQtyPerDate[key] || 0);
      d.setDate(d.getDate() + 1);
    }

    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const existing = cart.find(i => i.name === item.name);
    const currentQty = existing ? existing.quantity : 0;
    const newTotal = currentQty + (item.quantity || 1);

    if (maxBooked + newTotal > stockAvailable) {
      const left = Math.max(0, stockAvailable - maxBooked - currentQty);
      Swal.fire({
        icon: "error",
        title: "Not enough stock",
        text: `Only ${left} more ${item.name} available for your selected dates.`
      });
      return;
    }

    // ‚úÖ Safe to add to cart
    if (existing) {
      existing.quantity = newTotal;
    } else {
      cart.push(item);
    }
    localStorage.setItem("cart", JSON.stringify(cart));
    updateCartCount();

    // üîî NEW: Validate after adding
    validateCartStock(document.getElementById("rentalDateRange").value.trim());

    Swal.fire({ icon: "success", title: "Added", text: `${item.name} added to cart.` });

  } catch (err) {
    console.error("addToCart error:", err);
    Swal.fire({ icon: "error", title: "Error", text: "Could not check stock. Try again." });
  }
}


function addToCartWithQty(name, imageUrl) {
  const itemId = name.replace(/\s+/g, '-');
  const qtyEl = document.getElementById(`qty-${itemId}`);
  if (!qtyEl) return;
  const qty = Number(qtyEl.value) || 1;
  const totalBundle = Number(qtyMap[name]?.prices?.[qty]) || 0;
  const unitPrice = totalBundle / Math.max(1, qty);
  const days = 1;

  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  db.collection('gallery').where('name', '==', name).limit(1).get().then(snapshot => {
    if (snapshot.empty) return;

    const item = snapshot.docs[0].data();
    const category = (item.category || '').toUpperCase();
    const isRestricted = restrictedCategories.includes(category);
    const exists = cart.find(i => i.name === name);

    if (exists && isRestricted) {
      showToast("YOU CAN ONLY ADD THIS ITEM ONCE", "error");
      return;
    }

    if (exists) {
      exists.quantity = qty;
      exists.price = unitPrice;
      exists.days = days;
      exists.totalPrice = unitPrice * qty * days;
    } else {
      cart.push({ name, price: unitPrice, imageUrl, quantity: qty, totalPrice: unitPrice * qty * days, days, category });
    }

    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();

    // üîî NEW: Validate after adding
    validateCartStock(document.getElementById("rentalDateRange").value.trim());

    showToast("ADDED TO CART", "success");
  });
}



function updateCartCount() {
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  const count = cart.reduce((t, i) => t + (i.quantity || 0), 0);
  document.getElementById('cart-count').textContent = count;
}

function updateRentalDuration() {
  const rangeInput = document.getElementById('rentalDateRange');
  const dates = rangeInput.value.split(' to ');
  if (dates.length === 1 && dates[0]) dates[1] = dates[0];

  if (dates.length !== 2 || !dates[0] || !dates[1]) return;

  const start = new Date(dates[0]);
  const end = new Date(dates[1]);
  const msPerDay = 86400000;

  start.setHours(0,0,0,0);
  end.setHours(0,0,0,0);

  const days = Math.round((end - start) / msPerDay) + 1;
  if (isNaN(days) || days < 1) { alert("Please select a valid rental date range."); return; }

  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  cart.forEach(item => {
    item.days = days;
    item.totalPrice = item.price * item.quantity * days;
  });
  localStorage.setItem('cart', JSON.stringify(cart));
  viewCart();
}

  /* ===================== Global flag ===================== */
let cartHasWarnings = false;

/* ===================== Toggle Place Order button ===================== */
function togglePlaceOrderButton() {
  const btn = document.getElementById("placeOrderBtn");
  if (!btn) return;

  if (cartHasWarnings) {
    btn.disabled = true;
    btn.style.backgroundColor = "#999";   // greyed out
    btn.style.cursor = "not-allowed";
  } else {
    btn.disabled = false;
    btn.style.backgroundColor = "#6A0DAD"; // restore purple (or your theme color)
    btn.style.cursor = "pointer";
  }
}


function viewCart() {
  const modal = document.getElementById('cartModal');
  const container = document.getElementById('cartItemsContainer');
  const totalElem = document.getElementById('cartTotal');
  container.innerHTML = '';

  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  if (cart.length === 0) {
    container.innerHTML = '<p>Your cart is empty.</p>';
    totalElem.textContent = '';
    cartHasWarnings = false;
    togglePlaceOrderButton(); // ‚úÖ reset button state
  } else {
    let total = 0;
    cart.forEach((item, index) => {
      const days = item.days || 1;
      const quantity = item.quantity || 1;
      const unitPrice = item.price || 0;
      const itemTotal = unitPrice * quantity * days;
      total += itemTotal;

      const itemDiv = document.createElement('div');
      itemDiv.innerHTML = `
        <div style="display:flex; align-items:center; gap:8px; flex:1;">
          <img src="${item.imageUrl}" alt="${item.name}">
          <div>
            <div style="font-weight:bold;">${item.name}</div>
            <div>${quantity} √ó ${formatJMD(unitPrice)} √ó ${days} day(s)</div>
          </div>
        </div>
        <div style="font-weight:bold;">${formatJMD(itemTotal)}</div>
        <button onclick="removeFromCart(${index})"
          style="background:red; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">
          ‚úñ
        </button>`;
      container.appendChild(itemDiv);
    });

    totalElem.textContent = "TOTAL: " + formatJMD(total);

    // ‚ùå Removed validateCartStock() call here
    // Validation will only run on rentalDateRange change
    const rentalDates = (document.getElementById("rentalDateRange")?.value || "").trim();
    if (!rentalDates) {
      cartHasWarnings = false;
      togglePlaceOrderButton(); // ‚úÖ ensure button resets when no dates
    }
  }

  modal.style.display = 'block';
}


/* ===================== Cart Helpers ===================== */
function removeFromCart(index) {
  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  cart.splice(index, 1);
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartCount();

  // üîî NEW: Validate after removing
  validateCartStock(document.getElementById("rentalDateRange").value.trim());

  viewCart();
}

/* ===================== Toast Notifications ===================== */
function showToast(message, type) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.style.backgroundColor = type === "error" ? "#dc3545" : "#28a745";
  toast.style.display = "block";
  setTimeout(() => { toast.style.display = "none"; }, 2500);
}

/* ===================== Reviews ===================== */
function initReviews() {
  const starContainer = document.getElementById("starRating");
  if (starContainer) {
    starContainer.querySelectorAll("span").forEach(star => {
      star.addEventListener("click", () => {
        selectedRating = Number(star.getAttribute("data-value"));
        starContainer.querySelectorAll("span").forEach((s, i) => {
          s.style.color = i < selectedRating ? "#ffd700" : "#ccc";
        });
      });
    });
  }

  const form = document.getElementById("reviewForm");
  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("reviewName").value.trim();
      const comment = document.getElementById("reviewComment").value.trim();
      if (!name || !comment || !selectedRating) {
        Swal.fire({ icon: "error", title: "Missing fields", text: "Please fill everything and pick a rating." });
        return;
      }
      await db.collection("reviews").add({
        name, comment, rating: selectedRating,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById("reviewForm").reset();
      selectedRating = 0;
      document.getElementById("reviewSubmitMsg").textContent = "‚úÖ Review submitted!";
      loadReviews();
    });
  }

  loadReviews();
}

function loadReviews() {
  const container = document.getElementById("reviewsContainer");
  if (!container) return;
  container.innerHTML = "";
  db.collection("reviews").orderBy("createdAt", "desc").get().then(snapshot => {
    snapshot.forEach(doc => {
      const r = doc.data();
      const stars = "‚òÖ".repeat(r.rating || 0) + "‚òÜ".repeat(5 - (r.rating || 0));
      const div = document.createElement("div");
      div.style.marginBottom = "10px";
      div.innerHTML = `
        <div style="font-weight:bold; color:#9b59b6;">${r.name}</div>
        <div style="color:gold;">${stars}</div>
        <div>${r.comment}</div>
        <hr style="border:0; border-top:1px solid #555; margin:8px 0;">
      `;
      container.appendChild(div);
    });
  });
}

/* ===================== Event Listeners ===================== */
document.getElementById("closeCheckoutBtn").addEventListener("click", () => {
  document.getElementById("cartModal").style.display = "none";
});

document.getElementById("placeOrderBtn").addEventListener("click", completeBooking);

  document.getElementById("rentalDateRange").addEventListener("change", (e) => {
  const rentalDates = e.target.value.trim();
  validateCartStock(rentalDates);
});


/* ===================== Init ===================== */
window.addEventListener("load", () => {
  updateCartCount();
  fetchBookedDatesAndInitCalendar();
  initReviews();

  // üëá Show Event Items page immediately
  loadGalleryByCategory('EVENT ITEMS');
});

  async function checkStock(cart, start, end) {
  const snapshot = await db.collection("reservations").get();
  for (const cartItem of cart) {
    const itemName = cartItem.name;
    const qtyRequested = cartItem.quantity || 1;
    const stockAvailable = (qtyMap?.[itemName]?.options?.slice(-1)?.[0]) || 1;

    const bookedQtyPerDate = {};
    for (const doc of snapshot.docs) {
      const data = doc.data();
      if (!data.rentalDates || !data.cartItems) continue;

      const [bookedStartStr, bookedEndStr] = String(data.rentalDates).split(" to ");
      const bookedStart = new Date(bookedStartStr);
      const bookedEnd = new Date(bookedEndStr);
      if (isNaN(bookedStart) || isNaN(bookedEnd)) continue;
      if (start > bookedEnd || end < bookedStart) continue;

      for (const bookedItem of data.cartItems) {
        if (bookedItem.name !== itemName) continue;
        const bookedQty = bookedItem.quantity || 1;
        let d = new Date(bookedStart);
        while (d <= bookedEnd) {
          const key = d.toISOString().split("T")[0];
          bookedQtyPerDate[key] = (bookedQtyPerDate[key] || 0) + bookedQty;
          d.setDate(d.getDate() + 1);
        }
      }
    }

    let d = new Date(start);
    while (d <= end) {
      const key = d.toISOString().split("T")[0];
      if ((bookedQtyPerDate[key] || 0) + qtyRequested > stockAvailable) {
        return false; // Not enough stock for this item
      }
      d.setDate(d.getDate() + 1);
    }
  }
  return true; // All items available
  }

  async function validateCartStock(rentalDates) {
  const warningsDiv = document.getElementById("cartWarnings");
  warningsDiv.innerHTML = ""; 
  cartHasWarnings = false;

  if (!rentalDates.includes(" to ")) {
    togglePlaceOrderButton();
    return;
  }

  const [startStr, endStr] = rentalDates.split(" to ");
  const start = new Date(startStr);
  const end = new Date(endStr);
  if (isNaN(start) || isNaN(end)) {
    togglePlaceOrderButton();
    return;
  }

  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  if (cart.length === 0) {
    togglePlaceOrderButton();
    return;
  }

  // ‚úÖ Group cart by itemName (sum quantities)
  const cartGrouped = {};
  for (const item of cart) {
    cartGrouped[item.name] = (cartGrouped[item.name] || 0) + (item.quantity || 1);
  }

  const snapshot = await db.collection("reservations").get();
  const shownKeys = new Set();

  for (const [itemName, cartQty] of Object.entries(cartGrouped)) {
    const stockAvailable = (qtyMap?.[itemName]?.options?.slice(-1)?.[0]) || 1;

    // Build bookedQtyPerDate for this item
    const bookedQtyPerDate = {};
    snapshot.forEach(doc => {
      const data = doc.data();
      if (!data.rentalDates || !data.cartItems) return;

      const [bookedStartStr, bookedEndStr] = String(data.rentalDates).split(" to ");
      const bookedStart = new Date(bookedStartStr);
      const bookedEnd = new Date(bookedEndStr);
      if (isNaN(bookedStart) || isNaN(bookedEnd)) return;
      if (start > bookedEnd || end < bookedStart) return;

      for (const bookedItem of data.cartItems) {
        if (bookedItem.name !== itemName) continue;
        const bookedQty = bookedItem.quantity || 1;
        let d = new Date(bookedStart);
        while (d <= bookedEnd) {
          const key = d.toISOString().split("T")[0];
          bookedQtyPerDate[key] = (bookedQtyPerDate[key] || 0) + bookedQty;
          d.setDate(d.getDate() + 1);
        }
      }
    });

    // Compare demand vs stock per date
    let d = new Date(start);
    while (d <= end) {
      const key = d.toISOString().split("T")[0];
      const alreadyBooked = bookedQtyPerDate[key] || 0;
      const totalDemand = alreadyBooked + cartQty;

      if (totalDemand > stockAvailable) {
        const left = Math.max(0, stockAvailable - alreadyBooked);
        const uniqueKey = `${itemName}-${key}`;
        if (!shownKeys.has(uniqueKey)) {
          warningsDiv.innerHTML += `<div>‚ö†Ô∏è ${itemName} is overbooked on ${key}. Only ${left} available. Checkout disabled until fixed.</div>`;
          shownKeys.add(uniqueKey);
        }
        cartHasWarnings = true;
      }

      d.setDate(d.getDate() + 1);
    }
  }

  togglePlaceOrderButton();
}



</script>

