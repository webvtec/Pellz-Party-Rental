<!DOCTYPE html>

<html lang="en">
<head>
<!-- Essential for correct scaling on mobile -->
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>ADMIN DASHBOARD</title>
<link href="https://fonts.googleapis.com/css2?family=Zilla+Slab:wght@400;700&amp;display=swap" rel="stylesheet"/>
<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Zilla+Slab:wght@400;700&amp;display=swap" rel="stylesheet"/>
<style>
    html, body {
      width: 100%;
      min-width: 0;
      max-width: 100%;
      overflow-x: hidden;
      box-sizing: border-box;
      font-family: 'Zilla Slab', serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }

    .header-bar {
      background: #FFD1DC;
      padding: 16px 0;
      text-align: center;
      font-size: 2rem;
      font-weight: bold;
      color: #6200ea;
      width: 100%;
      box-sizing: border-box;
      margin: 0;
      border: none;
    }

    .top-menu {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      background: #6200ea;
      padding: 10px 0;
      width: 100%;
      box-sizing: border-box;
      margin: 0;
      border: none;
    }

    .top-menu button {
      flex: 1;
      margin: 5px;
      padding: 12px;
      border: none;
      border-radius: 5px;
      background: #fff;
      color: #6200ea;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      min-width: 120px;
      transition: background 0.2s;
    }

    .top-menu button:hover {
      background: #FFD1DC;
    }

    @media (max-width: 1200px) {
  .top-menu {
    flex-direction: column;
    align-items: center;  /* center buttons */
  }
  .top-menu button {
    width: 90%;          /* not full width */
    max-width: 300px;    /* shorter size */
    min-width: unset;
  }
}

    .admin-container {
      width: 100%;
      max-width: 1100px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.09);
      box-sizing: border-box;
      overflow-x: auto;
    }

    h2 {
      color: #6200ea;
      text-align: center;
    }

    input[type="text"], input[type="date"], input[type="time"], select {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    button {
      background: #6200ea;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
      font-size: 1rem;
      font-family: inherit;
    }
    button:hover {
      background: #3700b3;
    }

    .gallery-category {
      margin-top: 40px;
      width: 100%;
    }
    .gallery-category h3 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 22px;
      color: #6200ea;
      text-transform: uppercase;
    }

    .gallery-wrapper {
      width: 100%;
      margin: 0 auto;
      padding: 0 10px;
      box-sizing: border-box;
    }
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      margin-bottom: 30px;
      width: 100%;
    }

    @media (max-width: 1000px) {
      .gallery-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }

    .product-slot {
      display: flex;
      flex-direction: column;
      padding: 15px;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.09);
      width: 100%;
      box-sizing: border-box;
    }
    .product-slot input, .product-slot select {
      margin-bottom: 8px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .product-slot button {
      flex: 1;
      padding: 6px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .product-slot img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      margin-bottom: 8px;
      border-radius: 6px;
      background: #eee;
      border: 1px solid #eee;
    }

    .card-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
    }

    .delete-btn {
  background: #dc3545;   /* red */
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
}
.delete-btn:hover {
  background: #a71d2a;   /* darker red on hover */
}

.save-btn {
  background: #28a745;   /* green */
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
}
.save-btn:hover {
  background: #1e7e34;   /* darker green on hover */
}


    .gallery-grid div {
      position: relative;
    }
    .gallery-grid img {
      width: 100%;
      height: 250px;
      object-fit: cover;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
    }
    .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: red;
      color: white;
      border: none;
      padding: 5px 8px;
      border-radius: 5px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #6200ea;
      color: white;
    }
    .content-section {
      display: none;
      width: 100%;
    }
    .content-section.active {
      display: block;
      width: 100%;
    }
    .clear-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    .clear-container input {
      padding: 10px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .add-slot-container {
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
}

.add-slot-btn {
  background: #28a745;   /* green like Save */
  color: #fff;
  border: none;
  padding: 10px 18px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.2s;
}
.add-slot-btn:hover {
  background: #1e7e34;   /* darker green on hover */
}

    .product-slot textarea {
  margin-bottom: 8px;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-sizing: border-box;
  resize: vertical;         /* user can resize down/up */
  font-family: inherit;     /* match rest of inputs */
  font-size: 14px;
}

.reservation-card {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  padding: 15px;
  margin: 12px 0;
}

.reservation-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.reservation-header h3 {
  margin: 0;
  color: #6200ea;
}

.badge {
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: bold;
  color: #fff;
}
.badge.today { background: #28a745; }     /* green */
.badge.upcoming { background: #007bff; }  /* blue */


  </style>
</head>
<body>
<div class="header-bar">ADMIN DASHBOARD</div>
<div class="top-menu">
<button onclick="showSection('gallerySection')">GALLERY</button>
<button onclick="showSection('reservationsPage')">RESERVATIONS</button>
<button onclick="showSection('unavailableDaysSection')">UNAVAILABLE DAYS</button>
</div>
<!-- Gallery Management Page -->
<div class="admin-container content-section" id="gallerySection">
<div class="add-slot-container">
<button class="add-slot-btn" onclick="addNewSlot()">âž• Add New Slot</button>
</div>
<div id="adminGallery"></div>
</div>

   <!-- Reservations Section -->
<div class="admin-container content-section" id="reservationsPage">
  <h2>Reservations</h2>
  <div id="reservationsList"></div>
  <div class="clear-container">
    <input id="clearInput" type="text" placeholder='Type "CONFIRM" to clear past reservations'>
    <button onclick="clearReservations()">Clear Past Reservations</button>
  </div>
</div> 

<!-- Unavailable Days Page -->
<div class="admin-container content-section" id="unavailableDaysSection">
<h2>Set Unavailable Days</h2>
<input id="unavailableDateInput" type="date"/>
<label><input checked="" id="allDayCheckbox" onchange="toggleTimeInputs()" type="checkbox"/> All Day</label>
<div id="timeInputs" style="display: none;">
<label>FROM:</label>
<input id="startTimeInput" type="time"/>
<label>UNTIL:</label>
<input id="endTimeInput" type="time"/>
</div>
<button onclick="addUnavailableDate()">Add Unavailable Date</button>
<h3>Unavailable Dates</h3>
<ul id="unavailableDatesList"></ul>
</div>
<script>
    const firebaseConfig = {
  apiKey: "AIzaSyDccI-TdbCXAJr6CD77X4yOUOfezef7Oks",
  authDomain: "delivery-login-3a084.firebaseapp.com",
  projectId: "delivery-login-3a084",
  storageBucket: "delivery-login-3a084.firebasestorage.app",
  messagingSenderId: "201998621677",
  appId: "1:201998621677:web:b51c3aeb2debe18b4aa5e4"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function showSection(sectionId) {
      document.querySelectorAll('.content-section').forEach(section =>
        section.classList.remove('active')
      );
      document.getElementById(sectionId).classList.add('active');
    }

    function toggleTimeInputs() {
      const isAllDay = document.getElementById('allDayCheckbox').checked;
      document.getElementById('timeInputs').style.display = isAllDay ? 'none' : 'block';
    }

    function addPhotoUrl() {
  const nameInput = document.getElementById('itemNameInput');
  const urlInput = document.getElementById('photoUrlInput');
  const priceInput = document.getElementById('itemPriceInput'); // add this line
  const categorySelect = document.getElementById('photoCategorySelect');

  const name = nameInput.value.trim();
  const url = urlInput.value.trim();
  const price = parseFloat(priceInput.value); // add this line
  const category = categorySelect.value.trim();

  // Validate all fields
  if (name === '' || url === '' || isNaN(price) || category === '') {
    alert('Please enter a name, valid image URL, price, and select a category.');
    return;
  }

  // Save to Firebase (âœ… add price)
  db.collection('gallery').add({
    name: name,
    url: url,
    price: price,
    category: category
  })
  .then(() => {
    nameInput.value = '';
    urlInput.value = '';
    priceInput.value = ''; // clear price input
    categorySelect.value = '';
    alert('Item added successfully!');
  })
  .catch(error => {
    console.error("Error adding item: ", error);
    alert('Error adding item: ' + error.message);
  });
}

function loadGallery() {
  const galleryContainer = document.getElementById("adminGallery"); // âœ… correct ID

  db.collection("gallery").onSnapshot(snapshot => {
    galleryContainer.innerHTML = "";
    const items = [];

    snapshot.forEach(doc => {
      const data = doc.data();
      items.push({
        docId: doc.id,
        name: data.name || "",
        description: data.description || "",
        price: data.price || 0,
        imageUrl: data.url || data.imageUrl || "",
        category: (data.category || "Uncategorized").toUpperCase(),
        timestamp: data.timestamp ? (data.timestamp.toMillis?.() || data.timestamp) : 0
      });
    });

    // sort by newest first
    items.sort((a, b) => b.timestamp - a.timestamp);

    // group by category
    const categories = {};
    items.forEach(item => {
      if (!categories[item.category]) {
        categories[item.category] = [];
      }
      categories[item.category].push(item);
    });

    // render each category block
    Object.keys(categories).forEach(category => {
      const categoryContainer = document.createElement("div");
      categoryContainer.className = "gallery-category";
      categoryContainer.innerHTML = `<h2>${category}</h2>`;

      categories[category].forEach(item => {
        categoryContainer.innerHTML += `
          <div class="product-slot" id="${item.docId}">
            <img src="${item.imageUrl || 'https://via.placeholder.com/300x200?text=No+Image'}" alt="Product">
            <textarea id="name-${item.docId}" placeholder="Item Name" rows="2">${item.name}</textarea>
            <textarea id="desc-${item.docId}" placeholder="Item Description" rows="3">${item.description}</textarea>
            <input type="number" id="price-${item.docId}" value="${item.price}" placeholder="Price">
            <input type="text" id="url-${item.docId}" value="${item.imageUrl}" placeholder="Image URL">
            <select id="category-${item.docId}">
              <option value="EVENT ITEMS" ${item.category==="EVENT ITEMS"?"selected":""}>EVENT ITEMS</option>
              <option value="THRILL RIDES" ${item.category==="THRILL RIDES"?"selected":""}>THRILL RIDES</option>
              <option value="CARS" ${item.category==="CARS"?"selected":""}>CARS</option>
              <option value="BATHROOM" ${item.category==="BATHROOM"?"selected":""}>BATHROOM</option>
              <option value="UNCATEGORIZED" ${item.category==="UNCATEGORIZED"?"selected":""}>UNCATEGORIZED</option>
            </select>
            <div class="card-buttons">
              <button class="delete-btn" onclick="removePhoto('${item.docId}')">ðŸ—‘ Delete</button>
              <button class="save-btn" onclick="updateProduct('${item.docId}')">ðŸ’¾ Save</button>
            </div>
          </div>
        `;
      });

      galleryContainer.appendChild(categoryContainer);
    });
  });
}



    function removePhoto(docId) {
      db.collection('gallery').doc(docId).delete().catch((error) => {
        console.error("Error removing document: ", error);
        alert('Error removing photo: ' + error.message);
      });
    }

    function addNewSlot() {
      const galleryContainer = document.getElementById("adminGallery");
      const newId = "new-" + Date.now();

      galleryContainer.innerHTML += `
        <div class="product-slot" id="${newId}">
          <img src="" alt="Product">
          <textarea id="name-${newId}" placeholder="Item Name" rows="2"></textarea>\n<textarea id="desc-${newId}" placeholder="Item Description" rows="3"></textarea>
          <input type="number" id="price-${newId}" placeholder="Price">
          <input type="text" id="url-${newId}" placeholder="Image URL">
          <select id="category-${newId}">
            <option value="EVENT ITEMS">EVENT ITEMS</option>
            <option value="THRILL RIDES">THRILL RIDES</option>
            <option value="CARS">CARS</option>
            <option value="BATHROOM">BATHROOM</option>
          </select>
          <div class="card-buttons">
            <button class="delete-btn" onclick="document.getElementById('${newId}').remove()">ðŸ—‘ Delete</button>
            <button class="save-btn" onclick="saveNewProduct('${newId}')">ðŸ’¾ Save</button>
          </div>
        </div>
      `;
    }

function saveNewProduct(tempId) {
  const name = document.getElementById(`name-${tempId}`).value.trim();
  const description = document.getElementById(`desc-${tempId}`).value.trim();
  const price = parseFloat(document.getElementById(`price-${tempId}`).value) || 0;
  const url = document.getElementById(`url-${tempId}`).value.trim();
  const category = document.getElementById(`category-${tempId}`).value;

  if (!name || !url || !category) {
    alert("Please fill in all fields.");
    return;
  }

  db.collection("gallery").add({ 
      name, 
      description, 
      price, 
      url, 
      category,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()   // âœ… added
  })
  .then((docRef) => {
    alert("Product added successfully!");

    // update slot IDs to new docId
    const slot = document.getElementById(tempId);
    if (slot) {
      slot.id = docRef.id;
      document.getElementById(`name-${tempId}`).id = `name-${docRef.id}`;
      document.getElementById(`desc-${tempId}`).id = `desc-${docRef.id}`;
      document.getElementById(`price-${tempId}`).id = `price-${docRef.id}`;
      document.getElementById(`url-${tempId}`).id = `url-${docRef.id}`;
      document.getElementById(`category-${tempId}`).id = `category-${docRef.id}`;

      slot.querySelector(".save-btn").setAttribute("onclick", `updateProduct('${docRef.id}')`);
      slot.querySelector(".delete-btn").setAttribute("onclick", `removePhoto('${docRef.id}')`);
    }
  })
  .catch(err => alert("Error adding product: " + err.message));
}



    function updateProduct(docId) {
  const name = document.getElementById(`name-${docId}`).value.trim();
  const description = document.getElementById(`desc-${docId}`).value.trim();   // âœ… grab description
  const price = parseFloat(document.getElementById(`price-${docId}`).value) || 0;
  const url = document.getElementById(`url-${docId}`).value.trim();
  const category = document.getElementById(`category-${docId}`).value;

  if (!name || !url || !category) {
    alert("Please fill in all fields.");
    return;
  }

  db.collection("gallery").doc(docId).update({
    name, description, price, url, category   // âœ… include description
  })
  .then(() => alert("Product updated successfully!"))
  .catch(err => alert("Error updating product: " + err.message));
}


    function removePhoto(docId) {
      db.collection('gallery').doc(docId).delete().catch((error) => {
        console.error("Error removing document: ", error);
        alert('Error removing photo: ' + error.message);
      });
    }

     

function loadReservations() {
  const reservationsContainer = document.getElementById('reservationsList');
  db.collection('reservations').onSnapshot(snapshot => {
    reservationsContainer.innerHTML = '';
    const now = new Date();
    const reservations = [];

    snapshot.forEach(doc => {
      const booking = doc.data();
      let bookingDate = null;

      if (booking.rentalDates?.includes(' to ')) {
        bookingDate = new Date(booking.rentalDates.split(' to ')[0]);
      }

      if (booking.rentalDates) {
        reservations.push({ id: doc.id, bookingDate, ...booking });
      } else {
        reservations.push({ id: doc.id, bookingDate: new Date(0), ...booking });
      }
    });

    // âœ… sort newest â†’ oldest (so recent orders show up first)
    reservations.sort((a, b) => b.bookingDate - a.bookingDate);

    reservations.forEach(booking => {
      const dateStr = booking.rentalDates || 'N/A';
      const timeStr = `${booking.startTime || ''} - ${booking.endTime || ''}`;

      // âœ… Badge logic
      let badgeClass = 'upcoming';
      let badgeText = 'Upcoming';

      if (!booking.bookingDate || isNaN(booking.bookingDate)) {
        badgeClass = 'past';
        badgeText = 'Unknown Date';
      } else if (booking.bookingDate.toDateString() === now.toDateString()) {
        badgeClass = 'today';
        badgeText = 'Today';
      } else if (booking.bookingDate < now) {
        badgeClass = 'past';
        badgeText = 'Past';
      }

      const itemsList = (booking.cartItems || [])
        .map(i => `<li>${i.name} x${i.quantity}</li>`)
        .join('');

      reservationsContainer.innerHTML += `
        <div class="reservation-card">
          <div class="reservation-header">
            <h3>${booking.name} (Order #${booking.orderNumber || booking.id})</h3>
            <span class="badge ${badgeClass}">${badgeText}</span>
          </div>
          <p>ðŸ“ž ${booking.phone || 'N/A'}</p>
          <p><strong>Location:</strong> ${booking.location || 'N/A'}</p>
          <p><strong>Date:</strong> ${dateStr}</p>
          <p><strong>Time:</strong> ${timeStr}</p>
          <p><strong>Payment:</strong> ${booking.paymentType || ''}</p>
          <p><strong>Total:</strong> JMD $${(booking.totalAmount || 0).toLocaleString()}</p>
          <div><strong>Items:</strong><ul>${itemsList}</ul></div>
          ${booking.notes ? `<p><em>Notes: ${booking.notes}</em></p>` : ''}
        </div>`;
    });
  });
}


function clearReservations() {
  const confirmInput = document.getElementById('clearInput').value.trim();
  if (confirmInput !== 'CONFIRM') { alert('TYPE "CONFIRM" TO CLEAR PAST RESERVATIONS.'); return; }

  const now = new Date();
  db.collection('reservations').get().then(snapshot => {
    const batch = db.batch();
    snapshot.forEach(doc => {
      const booking = doc.data();
      if (booking.rentalDates?.includes(' to ')) {
        const bookingDate = new Date(booking.rentalDates.split(' to ')[1]);
        if (bookingDate && now - bookingDate > 24 * 60 * 60 * 1000) {
          batch.delete(doc.ref);
        }
      }
    });
    return batch.commit();
  }).then(() => {
    alert('Past reservations cleared successfully.');
    document.getElementById('clearInput').value = '';
  });
}

function loadUnavailableDates() {
  const list = document.getElementById('unavailableDatesList');
  db.collection('unavailableDays').orderBy('date').onSnapshot(snapshot => {
    list.innerHTML = '';
    snapshot.forEach(doc => {
      const d = doc.data();
      let text = `${d.date} - ${d.allDay ? 'All Day' : `${d.startTime} to ${d.endTime}`}`;
      list.innerHTML += `<li>${text} <button onclick="removeUnavailableDate('${doc.id}')">Remove</button></li>`;
    });
  });
}

function removeUnavailableDate(id) { db.collection('unavailableDays').doc(id).delete(); }

firebase.auth().onAuthStateChanged(user => {
  if (user) {
    loadGallery();   // âœ… add this
    showSection('reservationsPage');
    loadReservations();
    loadUnavailableDates();
  } else {
    window.location.href = 'index.html';
  }
});
  </script>
</body>
</html>
